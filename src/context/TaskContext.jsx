import React, { createContext, useContext, useReducer, useEffect } from 'react'\nimport { v4 as uuidv4 } from 'uuid'\n\nconst TaskContext = createContext()\n\n// 초기 상태\nconst initialState = {\n  tasks: [],\n  loading: false,\n  error: null\n}\n\n// UUID 생성 함수 (간단한 구현)\nfunction generateId() {\n  return Date.now().toString(36) + Math.random().toString(36).substr(2)\n}\n\n// 액션 타입\nconst ACTIONS = {\n  LOAD_TASKS: 'LOAD_TASKS',\n  ADD_TASK: 'ADD_TASK',\n  UPDATE_TASK: 'UPDATE_TASK',\n  DELETE_TASK: 'DELETE_TASK',\n  TOGGLE_TASK: 'TOGGLE_TASK',\n  SET_LOADING: 'SET_LOADING',\n  SET_ERROR: 'SET_ERROR'\n}\n\n// 리듀서\nfunction taskReducer(state, action) {\n  switch (action.type) {\n    case ACTIONS.LOAD_TASKS:\n      return {\n        ...state,\n        tasks: action.payload,\n        loading: false\n      }\n    \n    case ACTIONS.ADD_TASK:\n      return {\n        ...state,\n        tasks: [...state.tasks, action.payload]\n      }\n    \n    case ACTIONS.UPDATE_TASK:\n      return {\n        ...state,\n        tasks: state.tasks.map(task => \n          task.id === action.payload.id ? action.payload : task\n        )\n      }\n    \n    case ACTIONS.DELETE_TASK:\n      return {\n        ...state,\n        tasks: state.tasks.filter(task => task.id !== action.payload)\n      }\n    \n    case ACTIONS.TOGGLE_TASK:\n      return {\n        ...state,\n        tasks: state.tasks.map(task => \n          task.id === action.payload \n            ? { ...task, completed: !task.completed, updatedAt: new Date().toISOString() }\n            : task\n        )\n      }\n    \n    case ACTIONS.SET_LOADING:\n      return {\n        ...state,\n        loading: action.payload\n      }\n    \n    case ACTIONS.SET_ERROR:\n      return {\n        ...state,\n        error: action.payload,\n        loading: false\n      }\n    \n    default:\n      return state\n  }\n}\n\n// 컨텍스트 프로바이더\nexport function TaskProvider({ children }) {\n  const [state, dispatch] = useReducer(taskReducer, initialState)\n  \n  // 로컬스토리지에서 데이터 로드\n  useEffect(() => {\n    try {\n      const savedTasks = localStorage.getItem('simpletask-tasks')\n      if (savedTasks) {\n        const tasks = JSON.parse(savedTasks)\n        dispatch({ type: ACTIONS.LOAD_TASKS, payload: tasks })\n      } else {\n        dispatch({ type: ACTIONS.LOAD_TASKS, payload: [] })\n      }\n    } catch (error) {\n      console.error('할일 데이터 로드 실패:', error)\n      dispatch({ type: ACTIONS.SET_ERROR, payload: '데이터를 불러올 수 없습니다.' })\n    }\n  }, [])\n  \n  // 상태 변경시 로컬스토리지에 저장\n  useEffect(() => {\n    if (state.tasks.length > 0 || localStorage.getItem('simpletask-tasks')) {\n      localStorage.setItem('simpletask-tasks', JSON.stringify(state.tasks))\n    }\n  }, [state.tasks])\n  \n  // 할일 추가\n  const addTask = (taskData) => {\n    const newTask = {\n      id: generateId(),\n      title: taskData.title,\n      description: taskData.description || '',\n      category: taskData.category || '기타',\n      priority: taskData.priority || '보통',\n      dueDate: taskData.dueDate || null,\n      completed: false,\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString()\n    }\n    \n    dispatch({ type: ACTIONS.ADD_TASK, payload: newTask })\n    return newTask\n  }\n  \n  // 할일 수정\n  const updateTask = (id, updates) => {\n    const task = state.tasks.find(t => t.id === id)\n    if (!task) return\n    \n    const updatedTask = {\n      ...task,\n      ...updates,\n      updatedAt: new Date().toISOString()\n    }\n    \n    dispatch({ type: ACTIONS.UPDATE_TASK, payload: updatedTask })\n    return updatedTask\n  }\n  \n  // 할일 삭제\n  const deleteTask = (id) => {\n    dispatch({ type: ACTIONS.DELETE_TASK, payload: id })\n  }\n  \n  // 할일 완료/미완료 토글\n  const toggleTask = (id) => {\n    dispatch({ type: ACTIONS.TOGGLE_TASK, payload: id })\n  }\n  \n  // 할일 검색\n  const searchTasks = (query) => {\n    if (!query) return state.tasks\n    \n    return state.tasks.filter(task => \n      task.title.toLowerCase().includes(query.toLowerCase()) ||\n      task.description.toLowerCase().includes(query.toLowerCase())\n    )\n  }\n  \n  // 할일 필터링\n  const filterTasks = (filters) => {\n    let filtered = [...state.tasks]\n    \n    if (filters.category && filters.category !== '전체') {\n      filtered = filtered.filter(task => task.category === filters.category)\n    }\n    \n    if (filters.status === '완료') {\n      filtered = filtered.filter(task => task.completed)\n    } else if (filters.status === '미완료') {\n      filtered = filtered.filter(task => !task.completed)\n    }\n    \n    if (filters.dateRange) {\n      const today = new Date()\n      today.setHours(0, 0, 0, 0)\n      \n      switch (filters.dateRange) {\n        case '오늘':\n          filtered = filtered.filter(task => {\n            if (!task.dueDate) return false\n            const taskDate = new Date(task.dueDate)\n            taskDate.setHours(0, 0, 0, 0)\n            return taskDate.getTime() === today.getTime()\n          })\n          break\n        \n        case '이번 주':\n          const weekStart = new Date(today)\n          weekStart.setDate(today.getDate() - today.getDay())\n          const weekEnd = new Date(weekStart)\n          weekEnd.setDate(weekStart.getDate() + 6)\n          \n          filtered = filtered.filter(task => {\n            if (!task.dueDate) return false\n            const taskDate = new Date(task.dueDate)\n            return taskDate >= weekStart && taskDate <= weekEnd\n          })\n          break\n      }\n    }\n    \n    return filtered\n  }\n  \n  const value = {\n    ...state,\n    addTask,\n    updateTask,\n    deleteTask,\n    toggleTask,\n    searchTasks,\n    filterTasks\n  }\n  \n  return (\n    <TaskContext.Provider value={value}>\n      {children}\n    </TaskContext.Provider>\n  )\n}\n\n// 훅\nexport function useTasks() {\n  const context = useContext(TaskContext)\n  if (!context) {\n    throw new Error('useTasks는 TaskProvider 내부에서 사용해야 합니다.')\n  }\n  return context\n}